name: Build FLIP Fluids (Windows, MSVC)

on:
  workflow_dispatch:
    inputs:
      blender-version:
        description: 'Blender version to download (examples: 4.5, 5.0). Leave blank to provide custom URL.'
        required: false
        default: '4.5'
      blender-download-url:
        description: 'Optional: custom direct download URL to a Windows Blender zip. If provided, this is used instead of the preset URLs.'
        required: false
        default: ''

jobs:
  build:
    runs-on: windows-latest
    env:
      BUILD_CONFIG: Release

    steps:
      - name: Checkout repository at job ref
        uses: actions/checkout@v4
        with:
          # use the commit ref observed in the failing job so CI builds the same code you tested
          ref: df656fdc5ccd7e9757c30d8c3c9044e86b9d3a1c
          fetch-depth: 0

      - name: Show runner info
        run: |
          echo "Runner: $RUNNER_OS"
          cmake --version || echo "cmake not found"
          ninja --version || echo "ninja not found"

      - name: Determine Blender download URL
        id: blender
        run: |
          if ('${{ github.event.inputs.blender-download-url }}' -ne '') {
            echo "Using custom Blender URL"
            echo "url=${{ github.event.inputs.blender-download-url }}" >> $GITHUB_OUTPUT
          } else {
            $ver='${{ github.event.inputs.blender-version }}'
            if ($ver -like '5*') {
              # adjust exact patch if needed
              $url = "https://download.blender.org/release/Blender5.0/blender-5.0.0-windows-x64.zip"
            } else {
              # default: 4.5 LTS (adjust patch if Blender releases minor)
              $url = "https://download.blender.org/release/Blender4.5/blender-4.5.0-windows-x64.zip"
            }
            echo "url=$url" >> $GITHUB_OUTPUT
          }

      - name: Download and extract Blender
        run: |
          $dl = "${{ steps.blender.outputs.url }}"
          echo "Downloading Blender from $dl"
          $out = "$env:RUNNER_TEMP\\blender.zip"
          Invoke-WebRequest -Uri $dl -OutFile $out -UseBasicParsing
          $dest = "$env:RUNNER_TEMP\\blender"
          Remove-Item -Recurse -Force $dest -ErrorAction SilentlyContinue
          Expand-Archive -Path $out -DestinationPath $dest
          # Blender ZIP usually contains a top-level "blender" folder; find it
          $extracted = Get-ChildItem -Directory $dest | Select-Object -First 1
          if ($extracted) {
            $blender_root = Join-Path $dest $extracted.Name
          } else {
            $blender_root = $dest
          }
          echo "blender_root=$blender_root" >> $env:GITHUB_ENV
          echo "Blender extracted to $blender_root"

      - name: Configure build (CMake)
        env:
          BLENDER_ROOT: ${{ env.blender_root }}
        run: |
          echo "BLENDER_ROOT = $env:blender_root"
          mkdir build || exit 0
          cd build
          rem Choose generator: Visual Studio 17 2022 is present on windows-latest
          cmake -S .. -B . -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{ env.BUILD_CONFIG }} -DBLENDER_DIR="$env:blender_root"
          cd ..

      - name: Build (MSVC)
        run: |
          cd build
          cmake --build . --config ${{ env.BUILD_CONFIG }} --parallel
          cd ..

      - name: Package / Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: flip-fluids-windows-${{ env.BUILD_CONFIG }}
          path: |
            build/**/Release/*
            build/**/${{ env.BUILD_CONFIG }}/*

      - name: Print build location
        run: dir /s /b build || echo "build directory missing"
